<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quarter Tracker</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-512.png">

  <!-- Fonts & Styles -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css" />
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <span class="logo">QT</span>
      <h1>Quarter Tracker</h1>
    </div>

    <nav class="app-nav" aria-label="Navigazione principale">
      <button class="nav-btn" data-view="dashboard" aria-controls="view-dashboard">Dashboard</button>
      <button class="nav-btn" data-view="trattative" aria-controls="view-trattative">Trattative</button>
      <button class="nav-btn" data-view="report" aria-controls="view-report">Report</button>
      <button class="nav-btn" data-view="settings" aria-controls="view-settings">Impostazioni</button>
    </nav>

    <div class="header-actions">
      <label for="quarterSelector" class="sr-only">Seleziona trimestre</label>
      <select id="quarterSelector" title="Seleziona trimestre"></select>
      <button id="newDealBtn" class="primary">+ Nuovo deal</button>
    </div>
  </header>

  <main id="app" role="main">
    <!-- DASHBOARD -->
    <section id="view-dashboard" class="view active">
      <div class="kpi-grid" id="kpiGrid"></div>

      <div class="cards-row">
        <div class="card">
          <div class="card-header">
            <h3>Andamento cumulativo</h3>
            <span class="legend">Target atteso vs Fatto reale</span>
          </div>
          <div class="card-body">
            <canvas id="cumulativeChart" height="120"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Funnel trimestrale</h3>
            <span class="legend">Valore per stage</span>
          </div>
          <div class="card-body">
            <canvas id="funnelChart" height="120"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Settimane del trimestre</h3>
        </div>
        <div class="card-body">
          <table class="table" id="weeksTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Inizio</th>
                <th>Fine</th>
                <th>Fatto (cum.)</th>
                <th>Obiettivo (cum.)</th>
                <th>Scostamento</th>
                <th>Run-rate richiesto</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TRATTATIVE -->
    <section id="view-trattative" class="view">
      <div class="kanban" id="kanbanBoard"></div>
    </section>

    <!-- REPORT -->
    <section id="view-report" class="view">
      <div class="card">
        <div class="card-header">
          <h3>Report trimestrale</h3>
          <div class="actions">
            <button id="exportPdfBtn">Esporta PDF</button>
            <button id="exportJsonBtn">Backup JSON</button>
            <label class="import-label" style="display:inline-flex;gap:.5rem;align-items:center;cursor:pointer;">
              Importa JSON
              <input type="file" id="importJsonInput" accept="application/json" hidden>
            </label>
          </div>
        </div>
        <div class="card-body" id="reportArea">
          <div class="report-grid">
            <div id="reportKPIs"></div>
            <div class="report-chart">
              <canvas id="reportCumulativeChart" height="140"></canvas>
            </div>
            <div class="report-chart">
              <canvas id="reportFunnelChart" height="140"></canvas>
            </div>
            <div>
              <h4>Top deal vinti</h4>
              <ul id="topWonList" class="simple-list"></ul>
            </div>
            <div>
              <h4>Top pipeline</h4>
              <ul id="topPipelineList" class="simple-list"></ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- IMPOSTAZIONI -->
    <section id="view-settings" class="view">
      <div class="card">
        <div class="card-header"><h3>Target & date trimestre</h3></div>
        <div class="card-body settings-grid">
          <label>Anno
            <input type="number" id="setYear" min="2000" max="2100">
          </label>
          <label>Trimestre
            <select id="setQuarter">
              <option value="1">Q1 (Gen–Mar)</option>
              <option value="2">Q2 (Apr–Giu)</option>
              <option value="3">Q3 (Lug–Set)</option>
              <option value="4">Q4 (Ott–Dic)</option>
            </select>
          </label>
          <label>Target (€)
            <input type="number" id="setTarget" min="0" step="100">
          </label>
          <label>Inizio
            <input type="date" id="setStartDate">
          </label>
          <label>Fine
            <input type="date" id="setEndDate">
          </label>
          <label>Ferie (comma-separated)
            <input type="text" id="setHolidays" placeholder="2025-08-15, 2025-12-24">
          </label>
          <label>Pace
            <select id="setPaceCurve">
              <option value="linear">Lineare</option>
              <option value="ramp">Ramp (20/30/50)</option>
            </select>
          </label>
          <button id="saveQuarterBtn" class="primary">Salva trimestre</button>
          <button id="saveHolidaysBtn">Salva ferie</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h3>Stage & probabilità</h3></div>
        <div class="card-body">
          <div id="stagesConfig"></div>
          <div class="row-actions">
            <input type="text" id="addStageName" placeholder="Nuovo stage">
            <input type="number" id="addStageProb" min="0" max="100" step="5" placeholder="Prob (%)">
            <button id="addStageBtn">Aggiungi stage</button>
          </div>
          <small class="muted">Gli stage <b>vinto</b> e <b>perso</b> sono obbligatori e non eliminabili.</small>
          <div class="row-actions">
            <button id="saveStagesBtn">Salva stage & probabilità</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h3>Aspetto & dati</h3></div>
        <div class="card-body settings-grid">
          <label>Tema
            <select id="setTheme">
              <option value="light">Chiaro</option>
              <option value="dark">Scuro</option>
            </select>
          </label>
          <label>Valuta
            <input type="text" id="setCurrency" value="€">
          </label>
          <div class="row-actions">
            <button id="seedDemoBtn">Ricarica dati demo</button>
            <button id="resetAllBtn" class="danger">Reset totale</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modale Deal (create/edit) -->
  <div id="dealModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="deal-modal-title">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 id="deal-modal-title">Deal</h3>
        <button class="icon-btn" id="closeDealModal" aria-label="Chiudi">✕</button>
      </div>
      <div class="modal-body grid-2">
        <label>Nome deal
          <input type="text" id="dealName" placeholder="Es. CRM Enterprise">
        </label>
        <label>Cliente
          <input type="text" id="dealClient" placeholder="Es. Aemilia Medical">
        </label>
        <label>Valore (€)
          <input type="number" id="dealValue" min="0" step="100">
        </label>
        <label>Stage
          <select id="dealStage"></select>
        </label>
        <label>Probabilità (%) <small>(auto dallo stage, modificabile)</small>
          <input type="number" id="dealProbability" min="0" max="100" step="5">
        </label>
        <label>Chiusura prevista
          <input type="date" id="dealECD">
        </label>
        <label>Tag
          <input type="text" id="dealTags" placeholder="comma, separated">
        </label>
        <label>Note
          <textarea id="dealNotes" rows="3" placeholder="Dettagli, vincoli, prossimi passi..."></textarea>
        </label>
      </div>
      <div class="modal-footer">
        <button id="saveDealBtn" class="primary">Salva</button>
        <button id="cancelDealBtn">Annulla</button>
      </div>
    </div>
  </div>

  <footer class="app-footer">
    <span>Quarter Tracker • Offline-first</span>
  </footer>

  <!-- Vendors -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- App modules -->
  <script type="module" src="assets/js/models.js"></script>
  <script type="module" src="assets/js/store.js"></script>
  <script type="module" src="assets/js/kpi.js"></script>
  <script type="module" src="assets/js/charts.js"></script>
  <script type="module" src="assets/js/app.js"></script>
</body>
</html>
